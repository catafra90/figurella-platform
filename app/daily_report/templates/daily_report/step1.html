{% extends "base.html" %}

{% block content %}
<div class="mt-4 space-y-6">
  <h2 class="text-2xl font-bold figurella-pink">Sales</h2>

  <form method="POST" onsubmit="saveStep1ToStorage()" id="step1-form" class="space-y-4">
    <div id="sales-container" class="space-y-6">
      <!-- Sales blocks will be inserted here -->
    </div>

    <!-- Add Sales Button -->
    <button type="button" id="add-sales" class="w-full bg-white border border-gray-300 rounded-full py-2 text-sm text-gray-700 hover:bg-gray-100">
      + Add
    </button>

    <!-- Next Button -->
    <div class="text-right">
      <button type="submit" class="bg-figurella text-white px-6 py-2 rounded-full shadow hover:bg-pink-700 transition">
        Next →
      </button>
    </div>
  </form>
</div>

<script>
// Create a new sales block
function createSalesBlock(clientName = "", pkg = "", revenue = "") {
  const block = document.createElement("div");
  block.className = "bg-white rounded-xl shadow p-4 space-y-3";
  block.innerHTML = `
    <div>
      <label class="block text-sm font-semibold text-gray-700">Client Name</label>
      <textarea name="client_name" rows="1" class="w-full border border-gray-300 rounded-md px-3 py-2">${clientName}</textarea>
    </div>
    <div>
      <label class="block text-sm font-semibold text-gray-700">Package</label>
      <textarea name="package" rows="1" class="w-full border border-gray-300 rounded-md px-3 py-2">${pkg}</textarea>
    </div>
    <div>
      <label class="block text-sm font-semibold text-gray-700">Revenue</label>
      <textarea name="revenue" rows="1" class="w-full border border-gray-300 rounded-md px-3 py-2">${revenue}</textarea>
    </div>
  `;
  return block;
}

// Load saved data from sessionStorage
window.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("sales-container");

  let saved = null;
  try {
    saved = JSON.parse(sessionStorage.getItem("step1"));
  } catch (e) {
    console.warn("⚠️ Invalid session data for step1:", e);
  }

  if (saved && saved.client_name?.length) {
    for (let i = 0; i < saved.client_name.length; i++) {
      const block = createSalesBlock(saved.client_name[i], saved.package[i], saved.revenue[i]);
      container.appendChild(block);
    }
  } else {
    for (let i = 0; i < 3; i++) {
      container.appendChild(createSalesBlock());
    }
  }
});

// Add new sales block
document.getElementById("add-sales").addEventListener("click", () => {
  const container = document.getElementById("sales-container");
  container.appendChild(createSalesBlock());
});

// Save form data to sessionStorage
function saveStep1ToStorage() {
  const form = document.getElementById("step1-form");
  const data = {
    client_name: Array.from(form.querySelectorAll('[name="client_name"]')).map(el => el.value),
    package: Array.from(form.querySelectorAll('[name="package"]')).map(el => el.value),
    revenue: Array.from(form.querySelectorAll('[name="revenue"]')).map(el => el.value)
  };
  sessionStorage.setItem("step1", JSON.stringify(data));
}
</script>
{% endblock %}
